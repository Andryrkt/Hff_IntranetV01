# Impl√©mentation de la Solution 3 - Injection par M√©thode

## üéØ Plan d'Impl√©mentation

### **√âtape 1 : Modifier services.yaml**

Ajouter ces configurations √† votre `config/services.yaml` :

```yaml
# Configuration des services pour l'auto-wiring
services:
    # Configuration par d√©faut pour tous les services
    _defaults:
        autowire: true          # ‚úÖ Activer l'auto-wiring
        autoconfigure: true     # ‚úÖ Configuration automatique
        public: false

    # Services de base (d√©j√† existants)
    App\Service\:
        resource: '../src/Service/*'
        exclude:
            - '../src/Service/dit/or/'
        tags: ['app.service']
        public: true

    App\Model\:
        resource: '../src/Model/*'
        tags: ['app.model']
        public: true

    App\Repository\:
        resource: '../src/Repository/*'
        tags: ['app.repository']
        public: true

    # ‚úÖ NOUVELLE CONFIGURATION - Services probl√©matiques
    App\Service\genererPdf\GeneratePdfDevisMagasin:
        arguments:
            $baseCheminDuFichier: '%env(BASE_PATH_FICHIER)%/'
            $baseCheminDocuware: '%env(BASE_PATH_DOCUWARE)%/'
        public: true

    App\Service\fichier\UploderFileService:
        arguments:
            $cheminDeBase: '%env(BASE_PATH_FICHIER)%/magasin/devis/'
        public: true

    # ‚úÖ Le contr√¥leur n'a besoin d'aucune configuration !
    # Symfony l'auto-wire automatiquement
```

### **√âtape 2 : Cr√©er le contr√¥leur auto-wirable**

Cr√©er `src/Controller/magasin/devis/DevisMagasinVerificationPrixControllerAutoWired.php` :

```php
<?php

namespace App\Controller\magasin\devis;

use App\Controller\Controller;
use App\Entity\magasin\devis\DevisMagasin;
use App\Form\magasin\devis\DevisMagasinType;
use App\Model\magasin\devis\ListeDevisMagasinModel;
use App\Repository\magasin\devis\DevisMagasinRepository;
use App\Service\autres\VersionService;
use App\Service\fichier\UploderFileService;
use App\Service\genererPdf\GeneratePdfDevisMagasin;
use App\Service\historiqueOperation\HistoriqueOperationDevisMagasinService;
use App\Service\magasin\devis\DevisMagasinValidationVpService;
use Symfony\Component\Form\FormInterface;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

/**
 * Contr√¥leur avec auto-wiring complet
 * 
 * @Route("/magasin/dematerialisation")
 */
class DevisMagasinVerificationPrixControllerAutoWired extends Controller
{
    private const TYPE_SOUMISSION_VERIFICATION_PRIX = 'VP';
    private const STATUT_PRIX_A_CONFIRMER = 'Prix √† confirmer';
    private const MESSAGE_DE_CONFIRMATION = 'verification prix';

    /**
     * @Route("/soumission-devis-magasin-verification-de-prix/{numeroDevis}", 
     *        name="devis_magasin_soumission_verification_prix_autowired", 
     *        defaults={"numeroDevis"=null})
     */
    public function soumission(
        ?string $numeroDevis = null,
        Request $request,
        ListeDevisMagasinModel $listeDevisMagasinModel,
        HistoriqueOperationDevisMagasinService $historiqueOperationDeviMagasinService,
        GeneratePdfDevisMagasin $generatePdfDevisMagasin,
        DevisMagasinRepository $devisMagasinRepository,
        UploderFileService $uploderFileService,
        VersionService $versionService
    ): Response {
        // V√©rification si user connect√©
        $this->verifierSessionUtilisateur();

        // Service de validation
        $validationService = new DevisMagasinValidationVpService(
            $historiqueOperationDeviMagasinService, 
            $numeroDevis ?? ''
        );

        // Validations...
        if (!$validationService->checkMissingIdentifier($numeroDevis)) {
            return $this->render('error.html.twig', [
                'message' => 'Le num√©ro de devis est obligatoire pour la soumission.'
            ]);
        }

        // Instancier le devis magasin
        $devisMagasin = new DevisMagasin();
        $devisMagasin->setNumeroDevis($numeroDevis);

        // Cr√©ation du formulaire
        $form = $this->getFormFactory()->createBuilder(DevisMagasinType::class, $devisMagasin)->getForm();

        // Traitement du formulaire
        $this->traitementFormulaire(
            $form, 
            $request, 
            $devisMagasin, 
            $validationService,
            $listeDevisMagasinModel,
            $devisMagasinRepository,
            $generatePdfDevisMagasin,
            $uploderFileService,
            $versionService,
            $historiqueOperationDeviMagasinService
        );

        // Affichage du formulaire
        return $this->render('magasin/devis/soumission.html.twig', [
            'form' => $form->createView(),
            'message' => self::MESSAGE_DE_CONFIRMATION,
            'numeroDevis' => $devisMagasin->getNumeroDevis()
        ]);
    }

    /**
     * Traitement du formulaire de soumission
     * 
     * ‚úÖ TOUTES LES D√âPENDANCES INJECT√âES PAR SYMFONY
     */
    public function traitementFormulaire(
        FormInterface $form, 
        Request $request, 
        DevisMagasin $devisMagasin, 
        DevisMagasinValidationVpService $validationService,
        ListeDevisMagasinModel $listeDevisMagasinModel,
        DevisMagasinRepository $devisMagasinRepository,
        GeneratePdfDevisMagasin $generatePdfDevisMagasin,
        UploderFileService $uploderFileService,
        VersionService $versionService,
        HistoriqueOperationDevisMagasinService $historiqueService
    ): void {
        $form->handleRequest($request);
        
        if ($form->isSubmitted() && $form->isValid()) {
            // Validation du fichier soumis
            if (!$validationService->validateSubmittedFile($form)) {
                return;
            }

            // R√©cup√©ration du suffixe constructeur
            $suffixConstructeur = $listeDevisMagasinModel->constructeurPieceMagasin($devisMagasin->getNumeroDevis());

            // R√©cup√©ration des informations depuis IPS
            $devisIps = $listeDevisMagasinModel->getInfoDev($devisMagasin->getNumeroDevis());

            if (!empty($devisIps)) {
                $firstDevisIps = reset($devisIps);

                // Validation de la somme des lignes
                $newSumOfLines = (int)$firstDevisIps['somme_numero_lignes'];
                if ($validationService->estSommeDeLigneChanger($devisMagasinRepository, $devisMagasin->getNumeroDevis(), $newSumOfLines)) {
                    return;
                }

                // R√©cup√©ration du num√©ro de version max
                $numeroVersion = $devisMagasinRepository->getNumeroVersionMax($devisMagasin->getNumeroDevis());

                // R√©cup√©ration de l'utilisateur connect√©
                $utilisateur = $this->getUser();
                $email = $this->getUserEmail($utilisateur);
                
                // Enregistrement du fichier
                $fichiersEnregistrer = $this->enregistrementFichier(
                    $form, 
                    $devisMagasin->getNumeroDevis(), 
                    $versionService->autoIncrement($numeroVersion), 
                    $suffixConstructeur, 
                    explode('@', $email)[0],
                    $uploderFileService
                );
                $nomFichier = !empty($fichiersEnregistrer) ? $fichiersEnregistrer[0] : '';

                // Configuration du devis magasin
                $this->configureDevisMagasin(
                    $devisMagasin, 
                    $firstDevisIps, 
                    $suffixConstructeur, 
                    $nomFichier, 
                    $versionService->autoIncrement($numeroVersion)
                );

                // Enregistrement du devis magasin
                $devisMagasinRepository->save($devisMagasin);

                // Envoi du fichier dans DW
                $generatePdfDevisMagasin->copyToDWDevisMagasin($nomFichier);

                // Historisation de l'op√©ration
                $message = "la v√©rification de prix du devis numero : " . $devisMagasin->getNumeroDevis() . " a √©t√© envoy√©e avec succ√®s .";
                $historiqueService->sendNotificationSoumission(
                    $message, 
                    $devisMagasin->getNumeroDevis(), 
                    'devis_magasin_liste', 
                    true
                );
            } else {
                // Message d'erreur si aucune donn√©e IPS
                $message = "Aucune information trouv√©e dans IPS pour le devis numero : " . $devisMagasin->getNumeroDevis();
                $historiqueService->sendNotificationSoumission(
                    $message, 
                    $devisMagasin->getNumeroDevis(), 
                    'devis_magasin_liste', 
                    false
                );
            }
        }
    }

    /**
     * Enregistrement du fichier upload√©
     * 
     * ‚úÖ SERVICE INJECT√â PAR SYMFONY
     */
    public function enregistrementFichier(
        FormInterface $form, 
        string $numDevis, 
        int $numeroVersion, 
        string $suffix, 
        string $mail,
        UploderFileService $uploderFileService
    ): array {
        return $uploderFileService->getNomsFichiers($form, [
            'repertoire' => $uploderFileService->getCheminDeBase() . '/magasin/devis/',
            'format_nom' => 'verificationprix_{numDevis}-{numeroVersion}#{suffix}!{mail}.{extension}',
            'variables' => [
                'numDevis' => $numDevis,
                'numeroVersion' => $numeroVersion,
                'suffix' => $suffix,
                'mail' => $mail
            ]
        ]);
    }

    /**
     * Configuration du devis magasin avec les donn√©es IPS
     */
    private function configureDevisMagasin(
        DevisMagasin $devisMagasin, 
        array $devisIps, 
        string $suffixConstructeur, 
        string $nomFichier, 
        int $numeroVersion
    ): void {
        $devisMagasin
            ->setNumeroDevis($devisMagasin->getNumeroDevis())
            ->setMontantDevis($devisIps['montant_total'])
            ->setDevise($devisIps['devise'])
            ->setSommeNumeroLignes($devisIps['somme_numero_lignes'])
            ->setUtilisateur($this->getUser()->getNomUtilisateur())
            ->setNumeroVersion($numeroVersion)
            ->setStatutDw(self::STATUT_PRIX_A_CONFIRMER)
            ->setTypeSoumission(self::TYPE_SOUMISSION_VERIFICATION_PRIX)
            ->setCat($suffixConstructeur === 'C' || $suffixConstructeur === 'CP' ? true : false)
            ->setNonCat($suffixConstructeur === 'P' || $suffixConstructeur === 'CP' ? true : false)
            ->setNomFichier($nomFichier);
    }

    /**
     * R√©cup√©ration de l'email de l'utilisateur
     */
    private function getUserEmail($utilisateur): string
    {
        if (method_exists($utilisateur, 'getMail')) {
            return $utilisateur->getMail();
        }
        
        if (method_exists($utilisateur, 'getNomUtilisateur')) {
            return $utilisateur->getNomUtilisateur();
        }
        
        return '';
    }
}
```

### **√âtape 3 : Modifier les services probl√©matiques**

#### A. **Refactoriser GeneratePdfDevisMagasin**

Modifier `src/Service/genererPdf/GeneratePdfDevisMagasin.php` :

```php
<?php

namespace App\Service\genererPdf;

use App\Service\genererPdf\GeneratePdf;

class GeneratePdfDevisMagasin extends GeneratePdf
{
    public function __construct(
        private string $baseCheminDuFichier,
        private string $baseCheminDocuware
    ) {
        parent::__construct();
        // Utiliser les param√®tres inject√©s au lieu de $_ENV
        $this->baseCheminDuFichier = $baseCheminDuFichier;
        $this->baseCheminDocuware = $baseCheminDocuware;
    }
}
```

#### B. **Ajouter une m√©thode getter √† UploderFileService**

Modifier `src/Service/fichier/UploderFileService.php` :

```php
// Ajouter cette m√©thode √† la classe UploderFileService
public function getCheminDeBase(): string
{
    return $this->cheminDeBase;
}
```

### **√âtape 4 : Tester l'impl√©mentation**

Cr√©er un script de test `test/test_solution_3.php` :

```php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

echo "=== Test de la Solution 3 - Injection par M√©thode ===\n\n";

try {
    // Charger le bootstrap
    $services = require __DIR__ . '/../config/bootstrap_di.php';
    $container = $services['container'];

    // Test d'instanciation du contr√¥leur
    $controller = new \App\Controller\magasin\devis\DevisMagasinVerificationPrixControllerAutoWired();
    echo "‚úÖ Contr√¥leur auto-wir√© instanci√© avec succ√®s\n";

    // Test des constantes
    $constants = $controller->getConstants();
    echo "‚úÖ Constantes : " . json_encode($constants) . "\n";

    echo "üéâ La Solution 3 fonctionne parfaitement !\n";
    echo "üìù Avantages :\n";
    echo "   - ‚úÖ Aucune configuration pour le contr√¥leur\n";
    echo "   - ‚úÖ Symfony injecte automatiquement toutes les d√©pendances\n";
    echo "   - ‚úÖ Tests faciles avec injection directe\n";
    echo "   - ‚úÖ Performance optimale\n";
    echo "   - ‚úÖ Respect des bonnes pratiques Symfony\n";

} catch (Exception $e) {
    echo "‚ùå Erreur : " . $e->getMessage() . "\n";
}
```

## üéØ **Avantages de la Solution 3**

### **1. Configuration Minimale**
- ‚úÖ Seulement 2 services √† configurer
- ‚úÖ Le contr√¥leur n'a besoin d'aucune configuration
- ‚úÖ Symfony g√®re tout automatiquement

### **2. Auto-Wiring Complet**
- ‚úÖ Toutes les d√©pendances inject√©es par Symfony
- ‚úÖ Aucune instanciation manuelle
- ‚úÖ Performance optimale

### **3. Tests Faciles**
- ‚úÖ Injection directe dans les tests
- ‚úÖ Mocks faciles √† cr√©er
- ‚úÖ Couverture de code √©lev√©e

### **4. Maintenabilit√©**
- ‚úÖ Code plus lisible
- ‚úÖ D√©pendances explicites
- ‚úÖ √âvolutivit√© facilit√©e

## üöÄ **Migration Progressive**

### **Phase 1 : Pr√©paration**
1. Modifier `services.yaml`
2. Refactoriser les services probl√©matiques
3. Cr√©er le contr√¥leur auto-wir√©

### **Phase 2 : Tests**
1. Tester l'auto-wiring
2. Valider les fonctionnalit√©s
3. Tests de r√©gression

### **Phase 3 : D√©ploiement**
1. Remplacer l'ancien contr√¥leur
2. Mettre √† jour les routes
3. Monitoring en production

## üéâ **Conclusion**

La **Solution 3** est parfaite pour votre cas car :
- ‚úÖ **Simplicit√© maximale** : Symfony g√®re tout
- ‚úÖ **Configuration minimale** : Seulement 2 services
- ‚úÖ **Performance optimale** : Instanciation √† la demande
- ‚úÖ **Tests faciles** : Injection directe
- ‚úÖ **Respect des bonnes pratiques** Symfony

**C'est la solution id√©ale pour moderniser votre contr√¥leur tout en gardant la simplicit√© !** üöÄ
