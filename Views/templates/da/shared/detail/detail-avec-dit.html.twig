{% import "macroForm.html.twig" as macroForm %}

<div class="row">
	<h3 class="perso-titre">
		<span class="urgency-level">{{ dit.idNiveauUrgence.description }}</span>
		Détails Demande d'achat, n°
		{{ demandeAppro.numeroDemandeAppro }}
	</h3>
</div>

<div class="row">
	<div class="col-12 col-md-4">
		{{ macroForm.sousTitre('Information sur la demande') }}
		{{ macroForm.affichage2('Objet de la demande', demandeAppro.objetDal, 'mb-2') }}
		{{ macroForm.affichage2('Détail de la demande', demandeAppro.detailDal, 'h-90 mb-2') }}
		{{ macroForm.affichage2('Date fin souhaitée', demandeAppro.dateFinSouhaite|date('d/m/Y'), 'mb-2') }}
	</div>
	<div class="col-12 col-md-4">
		{{ macroForm.sousTitre('Agence et service') }}
		<div class="row">
			<div class="col-6 col-md-6">
				{{ macroForm.sousTitre('Emetteur') }}
				{{ macroForm.affichage2('Agence', demandeAppro.agenceEmetteur.codeAgence ~ ' ' ~ demandeAppro.agenceEmetteur.libelleAgence, 'mb-2') }}
				{{ macroForm.affichage2('Service', demandeAppro.serviceEmetteur.codeService ~ ' ' ~  demandeAppro.serviceEmetteur.libelleService, 'mb-2') }}
			</div>
			<div class="col-6 col-md-6">
				{{ macroForm.sousTitre('Débiteur') }}
				{{ macroForm.affichage2('Agence Débiteur', demandeAppro.agenceDebiteur.codeAgence ~ ' ' ~ demandeAppro.agenceDebiteur.libelleAgence, 'mb-2') }}
				{{ macroForm.affichage2('Service Débiteur', demandeAppro.serviceDebiteur.codeService ~ ' ' ~  demandeAppro.serviceDebiteur.libelleService, 'mb-2') }}
			</div>
		</div>
	</div>
	<div class="col-12 col-md-4">
		{{ macroForm.sousTitre('Information Matériel / DIT') }}
		<div class="row">
			<div class="col-md-6 col-6">
				{{ macroForm.affichage2('Id Matériel', demandeAppro.dit.idMateriel, 'mb-2') }}
				{{ macroForm.affichage2('Série', numSerie, 'mb-2') }}
			</div>
			<div class="col-md-6 col-6">
				{{ macroForm.affichage2('N° Parc', numParc, 'mb-2') }}
				{{ macroForm.affichage2('N° DIT', demandeAppro.dit.numeroDemandeIntervention, 'mb-2') }}
			</div>
			<div class="col-md-12 col-12">
				{{ macroForm.affichage2('Objet du DIT', demandeAppro.dit.objetDemande, 'mb-2') }}
			</div>
			{% if demandeAppro.nomFichierBav is not null and estAte %}
				<a class="fw-bold" href="{{ App.base_path_fichier }}/da/{{ demandeAppro.numeroDemandeAppro }}/{{demandeAppro.nomFichierBav}}" download>Télécharger le bon d'achat</a>
			{% endif %}
		</div>
	</div>
</div>
<div class="d-flex justify-content-end">
	<a href="{{ path("da_edit_avec_dit", {id: demandeAppro.id})}}" class="btn bouton mt-2 me-4 {{ estAte and statutAutoriserModifAte ? '' : 'd-none'}}" target="_blank">
		Modifier la demande
	</a>
</div>

<table class="table rounded table-plein-ecran mt-4">
	<thead class="table-dark text-center">
		<tr>
			<th class="text-center">
				<button class="btn btn-outline-info btn-sm rounded toggle-btn pb-0" id="toggle-all" data-bs-original-title="Tout fermer" data-bs-toggle="tooltip">
					<i class="fas fa-chevron-up"></i>
				</button>
			</th>
			<th class="text-start">Famille</th>
			<th class="text-start">Sous-famille</th>
			<th class="text-start">Référence</th>
			<th class="text-start">Désignation</th>
			<th class="text-start">Fournisseur</th>
			<th class="text-start">Date fin souhaitée</th>
			<th class="text-end">Prix Unitaire</th>
			<th class="text-center">Quantité dem / dispo</th>
			<th class="text-start">Commentaire / motif</th>
			<th class="text-start">Pièces jointes</th>
			<th class="text-start">Fiche technique</th>
			<th class="text-center">Suppression</th>
		</tr>
	</thead>
	<tbody>
		{% for DAL in demandeApproLines %}
			{% set choisi = DAL.demandeApproLR is empty %}
			<tr class="parent-row align-middle fw-bold">
				<td class="text-center p-1 {{ choisi ? 'bg-warning' : ''}}">
					<button class="btn btn-outline-primary btn-sm rounded toggle-btn pb-0">
						<i class="fas fa-chevron-up"></i>
					</button>
				</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.artFams1 }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.artFams2 }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.artRefp }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.artDesi }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.nomFournisseur }}</td>
				<td class="text-center {{ choisi ? 'bg-warning' : ''}}">{{ DAL.dateFinSouhaite }}</td>
				<td class="format-mtt text-end {{ choisi ? 'bg-warning' : ''}}">{{ DAL.prixUnitaire }}</td>
				<td class="text-center {{ choisi ? 'bg-warning' : ''}}">{{ DAL.qteDem }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">{{ DAL.commentaire }}</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">
					{% if DAL.fileNames|length > 0 %}
						<ul class="mb-0 px-0">
							{% for file in DAL.fileNames %}
								<li>
									<a href="{{ App.base_path_fichier }}/da/{{ DAL.numeroDemandeAppro }}/{{ file }}" target="_blank">{{ file }}</a>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						Aucune pièce jointe
					{% endif %}
				</td>
				<td class="{{ choisi ? 'bg-warning' : ''}}">
					{% if DAL.estFicheTechnique %}
						{% if DAL.nomFicheTechnique %}
							<a href="{{ App.base_path_fichier }}/da/{{ DAL.numeroDemandeAppro }}/{{ DAL.nomFicheTechnique }}" target="_blank">{{ DAL.nomFicheTechnique }}</a>
						{% else %}
							Fiche technique pas encore attachée
						{% endif %}
					{% else %}
						NON
					{% endif %}
				</td>
				<td class="text-center {{ choisi ? 'bg-warning' : ''}}">
					<i class="fas fa-trash-can text-danger fs-6 delete-line-DA" style="cursor:pointer;" title="Supprimer la ligne de DA" data-bs-toggle="tooltip" data-delete-path="{{ DAL.urlDelete }}"></i>
				</td>
			</tr>
			{% if DAL.demandeApproLR is empty %}
				<tr class="child-row">
					<td colspan="14" class="text-center">Aucune ligne de proposition de l'APPRO</td>
				</tr>
			{% else %}
				{% for item in DAL.demandeApproLR %}
					{% set choisi = item.choix %}
					<tr class="child-row">
						<td class="{{ choisi ? 'bg-warning' : ''}}"></td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.artFams1 ?? '-' }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.artFams2 ?? '-' }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.artRefp ?? '-' }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.artDesi }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.nomFournisseur }}</td>
						<td class="text-center {{ choisi ? 'bg-warning' : ''}}">{{ DAL.dateFinSouhaite }}</td>
						<td class="text-end format-mtt {{ choisi ? 'bg-warning' : ''}}">{{ item.prixUnitaire }}</td>
						<td class="text-center {{ choisi ? 'bg-warning' : ''}}">{{ item.qteDispo ?? '-' }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">{{ item.motif }}</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">
							{% if item.fileNames|length > 0 %}
								<ul class="mb-0 px-0">
									{% for file in item.fileNames %}
										<li>
											<a href="{{ App.base_path_fichier }}/da/{{ item.numeroDemandeAppro }}/{{ file }}" target="_blank">{{ file }}</a>
										</li>
									{% endfor %}
								</ul>
							{% else %}
								Aucune pièce jointe
							{% endif %}
						</td>
						<td class="text-start {{ choisi ? 'bg-warning' : ''}}">
							{% if DAL.estFicheTechnique %}
								{% if item.nomFicheTechnique %}
									<a href="{{ App.base_path_fichier }}/da/{{ item.numeroDemandeAppro }}/{{ item.nomFicheTechnique }}" target="_blank">{{ item.nomFicheTechnique }}</a>
								{% else %}
									Fiche technique pas encore attachée
								{% endif %}
							{% else %}
								NON
							{% endif %}
						</td>
						<td class="{{ choisi ? 'bg-warning' : ''}}"></td>
					</tr>
				{% endfor %}
			{% endif %}
		{% endfor %}
	</tbody>
</table>
